# Label-Detection 技術文件

## 📋 專案概述
本專案是一個完全離線的 OCR 文字辨識系統，用於從標籤圖像中檢測和匹配特定的目標文字。

**最後更新日期**: 2025年11月20日  
**版本**: 1.0  
**OCR 引擎**: Tesseract OCR v5.4.0.20240606

---

## 🎯 專案目標
從標籤圖像（如電源適配器標籤）中識別特定的文字內容，包括：
- 多語言文字（英文、西班牙文、法文）
- 包含特殊符號的文字（括號、波浪號、井號等）
- 多詞組合的長文字（如 "ASSEMBLED IN VIETNAM"）

---

## 🏗️ 系統架構

### 核心組件
1. **OCR 引擎**: Tesseract OCR（完全離線）
   - 位置: `tesseract/tesseract.exe`
   - 語言模型: `tesseract/tessdata/eng.traineddata`
   - DLL 依賴: 52 個檔案，總計約 156 MB

2. **主程式**: `Text-Detection.py`
   - OCR 識別
   - 文字匹配
   - 結果輸出

3. **輔助程式**: `Label-Detection.py`
   - 模板匹配（未使用 OCR）

---

## ✅ 當前實作狀態

### 成功檢測的目標文字（8/12，67%）
1. ✅ **ASSEMBLED IN VIETNAM** - 組合匹配(3個詞), 信心度: 0.960
2. ✅ **MODEL (MODELO) NO. LA24BN** - 組合匹配(4個詞), 信心度: 0.915
3. ✅ **INPUT (ENTRADA): 100-240V~1.0A 50/60Hz** - 組合匹配(4個詞), 信心度: 0.915
4. ✅ **VPPCCCUUYWWD####** - 完全匹配, 信心度: 0.580
5. ✅ **CAN ICES(B)/NMB(B)** - 組合匹配(2個詞), 信心度: 0.915
6. ✅ **CUMPLE CON LA NOM-029-ENER-2017** - 組合匹配(4個詞), 信心度: 0.885
7. ✅ **AMAZON.COM SERVICES LLC** - 組合匹配(3個詞), 信心度: 0.930
8. ✅ **CAUTION-ELECTRICALLY OPERATED PRODUCT** - 組合匹配(3個詞), 信心度: 0.937

### 未成功檢測的目標文字（4/12，33%）
1. ❌ **AC ADAPTER** - OCR 有識別到 "AC" 和 "ADAPTER"，但不在連續位置
2. ❌ **OUTPUT (SALIDA): 18.0V 1.67A 30.0W** - OCR 識別各部分但順序不連續
3. ❌ **EFICIENCIA ENERGÉTICA** - 重音符號問題（識別為 "ENERGETICA" 缺少重音）
4. ❌ **ATTENTION-PRODUIT À COMMANDE ÉLECTRIQUE** - 特殊字元（À, É）無法正確匹配

---

## 🔧 核心技術實作

### 1. OCR 初始化
```python
TESSERACT_LOCAL = os.path.join(os.path.dirname(__file__), 'tesseract', 'tesseract.exe')
TESSERACT_SYSTEM = r'C:\Program Files\Tesseract-OCR\tesseract.exe'

def initialize_ocr():
    # 優先使用項目目錄中的 Tesseract（便於離線部署）
    if os.path.exists(TESSERACT_LOCAL):
        pytesseract.tesseract_cmd = TESSERACT_LOCAL
        os.environ['TESSDATA_PREFIX'] = os.path.join(os.path.dirname(__file__), 'tesseract', 'tessdata')
    else:
        # 回退到系統安裝的 Tesseract
        pytesseract.tesseract_cmd = TESSERACT_SYSTEM
```

**設計考量**:
- 自動檢測本地/系統 Tesseract
- 設定 TESSDATA_PREFIX 確保語言模型正確載入
- 便於打包到其他電腦使用

### 2. OCR 執行參數
```python
ocr_data = pytesseract.image_to_data(
    image, 
    lang='eng',
    config='--psm 6',  # 假設統一的文字塊
    output_type=pytesseract.Output.DICT
)
```

**PSM 模式說明**:
- PSM 6: 假設統一的文字塊（適合標籤圖像）
- 返回詳細資料：文字、信心度、邊界框位置

**信心度處理**:
- Tesseract 返回 0-100 的信心度
- 程式正規化為 0-1 範圍 (`confidence / 100.0`)
- 閾值設定: 0.3（過濾低信心度結果）

### 3. 文字匹配邏輯（核心演算法）

#### 匹配策略（依優先順序）
1. **完全匹配**: 目標文字完全等於識別文字
2. **包含匹配**: 單個 OCR 結果包含完整目標文字
3. **組合匹配**: 組合連續的多個 OCR 結果

#### 組合匹配詳細說明
```python
# 目標: "ASSEMBLED IN VIETNAM"
# OCR 識別: ["ASSEMBLED", "IN", "VIETNAM"]
# 結果: 組合三個連續詞匹配成功

# 關鍵邏輯:
# 1. 按 Y 座標排序（識別同一行的文字）
# 2. 嘗試組合連續的 OCR 結果
# 3. 限制組合詞數（目標詞數 + 最多1個額外詞）
# 4. 去除特殊字元後比較（處理括號、重音符號等）
```

#### 匹配優先級
```python
優先選擇:
1. 完全匹配 > 組合匹配 > 包含匹配
2. 詞數少的匹配（避免包含額外內容）
3. 信心度高的匹配
```

#### 特殊字元處理
```python
import re
target_alphanum = re.sub(r'[^a-z0-9]', '', target_clean)
detected_alphanum = re.sub(r'[^a-z0-9]', '', detected_clean)
# 去除所有非英數字元後比較
```

**目的**: 處理括號、連字號、重音符號等差異

---

## 📊 辨識效能分析

### OCR 識別階段
- **識別文字數**: 42 個（信心度 >= 0.3）
- **過濾文字數**: 2 個（信心度 < 0.3）
- **平均信心度**: 0.54-0.96

### 文字匹配階段
- **成功率**: 8/12 = 67%
- **完全匹配**: 1 個
- **組合匹配**: 7 個

### 失敗原因分析
1. **非連續文字** (2/4): AC ADAPTER, OUTPUT...
   - OCR 將文字拆分且不在連續位置
   - 可能原因: 標籤排版、文字間距大

2. **重音符號問題** (2/4): EFICIENCIA ENERGÉTICA, ATTENTION-PRODUIT...
   - Tesseract 英文模型無法正確識別重音符號
   - 建議解決方案: 使用多語言模型或加入模糊匹配

---

## 🐛 已知問題與限制

### 1. 重音符號識別不準確
**問題**: 
- "ENERGÉTICA" 被識別為 "ENERGETICA"（缺少重音 É）
- "À" 和 "É" 無法正確識別

**影響目標**:
- EFICIENCIA ENERGÉTICA
- ATTENTION-PRODUIT À COMMANDE ÉLECTRIQUE

**可能解決方案**:
```python
# 方案 A: 增加模糊匹配，忽略重音符號
import unicodedata
def remove_accents(text):
    return ''.join(c for c in unicodedata.normalize('NFD', text) 
                   if unicodedata.category(c) != 'Mn')

# 方案 B: 使用多語言模型
# 下載 spa.traineddata (西班牙文) 和 fra.traineddata (法文)
# 修改: lang='eng+spa+fra'
```

### 2. 非連續文字無法組合
**問題**: 
- "AC ADAPTER" 兩個詞被識別，但在不同位置
- 當前演算法只能組合「連續」的 OCR 結果

**影響目標**:
- AC ADAPTER
- OUTPUT (SALIDA): 18.0V 1.67A 30.0W

**可能解決方案**:
```python
# 方案: 擴展匹配範圍，允許跳過低信心度的詞
# 或者考慮相近 Y 座標（同一行）的所有詞組合
```

### 3. OCR 信心度閾值影響
**當前設定**: 0.3

**問題**: 
- 閾值太高: 可能過濾掉正確但低信心度的文字
- 閾值太低: 包含太多雜訊文字

**建議**: 
- 保持 0.3（經驗值）
- 如需調整，在程式開頭修改 `OCR_CONFIDENCE_THRESHOLD`

---

## 🔄 開發歷史與決策

### OCR 引擎選擇歷程
1. **EasyOCR** (初始選擇)
   - 優點: 易用、支援多語言
   - 缺點: 模型大、速度慢
   - 結果: 9/12 (75%)

2. **PaddleOCR** (嘗試但失敗)
   - 優點: 號稱效能優異
   - 缺點: API 不穩定、文件過時、參數經常變更
   - 結果: 1/12 (8%) - 放棄使用

3. **Tesseract OCR** (最終選擇) ✅
   - 優點: 成熟穩定、完全離線、快速
   - 缺點: 需要手動配置
   - 結果: 12/12 OCR 識別 → 8/12 匹配成功 (67%)

### 匹配邏輯演進
1. **v0.1**: 簡單的完全匹配 → 失敗率高
2. **v0.2**: 增加部分匹配（被包含） → 誤匹配太多（如 "A" 匹配所有包含 A 的文字）
3. **v0.3**: 移除部分匹配，增加組合匹配 → 誤匹配減少
4. **v1.0** (當前): 精確組合匹配（限制額外詞數） → 準確率提升 ✅

---

## 📁 檔案結構與作用

```
Label-Detection/
├── Text-Detection.py          # 主程式（OCR 文字辨識）
├── Label-Detection.py         # 標籤檢測（模板匹配，獨立功能）
├── 技術文件.md                # 本文件
├── 離線部署說明.md            # 部署指南
│
├── tesseract/                 # Tesseract OCR 離線包
│   ├── tesseract.exe          # OCR 執行檔 (1.51 MB)
│   ├── tessdata/              # 語言模型
│   │   ├── eng.traineddata    # 英文模型
│   │   └── osd.traineddata    # 方向檢測模型
│   └── *.dll                  # 52 個依賴庫 (~156 MB)
│       ├── libtesseract-5.dll # 核心庫 (96.77 MB)
│       ├── libicudt75.dll     # Unicode 支援 (29.32 MB)
│       └── ...                # 其他影像處理庫
│
├── input data/                # 輸入資料
│   ├── target/                # 目標圖像（待檢測）
│   │   └── Label.png          # 範例標籤圖像
│   ├── image/                 # （未使用）
│   └── text/
│       └── text.txt           # 目標文字清單（12 個）
│
├── result/                    # 輸出結果
│   ├── text_result_Label.png  # 標註結果的圖像
│   ├── text_result_Label.json # JSON 格式詳細結果
│   ├── text_detection_report.csv  # CSV 格式檢測報告
│   └── text_summary_report.json   # 總結報告
│
├── easyocr_models/            # EasyOCR 模型（已不使用但保留）
│   ├── craft_mlt_25k.pth
│   └── latin_g2.pth
│
└── OCR model/                 # PaddleOCR 模型（已不使用但保留）
    ├── ch_ppocr_mobile_v2.0_cls_infer/
    ├── latin_PP-OCRv3_rec_infer/
    └── Multilingual_PP-OCRv3_det_infer/
```

---

## 🎛️ 設定參數說明

### Text-Detection.py 中的可調參數

```python
# OCR 信心度閾值（第 16 行）
OCR_CONFIDENCE_THRESHOLD = 0.3  
# 說明: 低於此值的識別結果會被過濾
# 建議範圍: 0.2-0.5
# 預設值: 0.3

# 忽略大小寫（第 17 行）
IGNORE_CASE = True  
# 說明: 匹配時是否忽略大小寫
# 建議: 保持 True

# 匹配模式（第 18 行）
MATCH_MODE = "exact"  
# 可選值: "exact", "fuzzy"（未完全實作）
# 建議: 保持 "exact"

# Tesseract 路徑（第 22-24 行）
TESSERACT_LOCAL = os.path.join(os.path.dirname(__file__), 'tesseract', 'tesseract.exe')
TESSERACT_SYSTEM = r'C:\Program Files\Tesseract-OCR\tesseract.exe'
# 說明: 自動偵測，通常無需修改

# OCR 語言（第 60 行，initialize_ocr 函數內）
lang = 'eng'
# 可選值: 'eng', 'spa', 'fra', 'eng+spa+fra'（需下載對應 traineddata）
# 當前: 僅英文

# PSM 模式（第 136 行，perform_ocr_on_image 函數內）
config='--psm 6'
# PSM 值說明:
#   0 = 僅方向和腳本檢測
#   1 = 自動分頁
#   3 = 全自動分頁（預設）
#   6 = 假設統一的文字塊（當前使用）★
#   7 = 將圖像視為單行文字
#   8 = 將圖像視為單個詞
# 建議: 保持 6（適合標籤圖像）
```

---

## 🚀 效能優化建議

### 已實施的優化
1. ✅ 使用相對路徑（便於打包）
2. ✅ 優先使用本地 Tesseract（避免系統依賴）
3. ✅ 信心度過濾（減少雜訊）
4. ✅ 組合匹配限制詞數（避免誤匹配）

### 未來可優化項目
1. **多語言支援**
   - 下載 spa.traineddata 和 fra.traineddata
   - 修改語言參數: `lang='eng+spa+fra'`
   - 預期提升: 可能解決重音符號問題

2. **模糊匹配改進**
   - 實作 Levenshtein 距離計算
   - 允許少量字元差異（如重音符號）

3. **影像預處理**
   - 增加對比度
   - 二值化處理
   - 去除雜訊

4. **組合匹配增強**
   - 允許跳過低信心度詞
   - 考慮相近 Y 座標的所有詞（而非僅連續詞）

---

## 🧪 測試結果

### 測試圖像: Label.png
- **圖像類型**: 電源適配器標籤
- **文字特徵**: 多語言（英文、西班牙文）、包含特殊符號
- **OCR 識別**: 42 個文字區域
- **匹配成功**: 8/12 目標文字

### 詳細結果（CSV 報告）
```csv
目標圖像,目標文字,檢測狀態,識別文字,信心度,位置(x,y),尺寸(w×h)
Label.png,ASSEMBLED IN VIETNAM,成功,ASSEMBLED IN VIETNAM,0.960,"(102, 387)",200×12
Label.png,AC ADAPTER,失敗,N/A,N/A,N/A,N/A
Label.png,MODEL (MODELO) NO. LA24BN,成功,MODEL (MODELO) NO. LA24BN,0.915,"(80, 230)",245×16
...
```

---

## 📝 給未來維護者的建議

### 如果遇到新的標籤圖像檢測率低
1. **檢查 OCR 識別階段**
   ```bash
   # 查看 OCR 識別了哪些文字
   python Text-Detection.py | Select-String "識別到"
   ```

2. **調整信心度閾值**
   - 修改 `OCR_CONFIDENCE_THRESHOLD`
   - 降低閾值可能提升檢測率，但也會增加雜訊

3. **考慮影像預處理**
   - 如果圖像模糊或對比度低
   - 在 `perform_ocr_on_image` 前增加前處理

4. **檢查目標文字格式**
   - 確認 `text.txt` 中的文字與實際標籤一致
   - 注意大小寫、空格、特殊字元

### 如果需要支援更多語言
1. 下載語言模型: https://github.com/tesseract-ocr/tessdata
2. 將 `.traineddata` 檔案放入 `tesseract/tessdata/`
3. 修改 `lang` 參數（第 60 行）

### 如果需要打包到其他電腦
1. 確認 `tesseract/` 目錄完整（tesseract.exe + 52 DLL + tessdata）
2. 複製整個專案資料夾
3. 安裝 Python 套件（參見「離線部署說明.md」）
4. 執行測試確認可用

---

## 🔍 除錯指南

### 常見問題與解決方案

#### 1. TesseractNotFoundError
```
錯誤: pytesseract.pytesseract.TesseractNotFoundError
```
**原因**: 找不到 tesseract.exe  
**解決**: 
- 檢查 `tesseract/tesseract.exe` 是否存在
- 檢查路徑設定（TESSERACT_LOCAL）

#### 2. TesseractError: Error opening data file
```
錯誤: Error opening data file tessdata/eng.traineddata
```
**原因**: 找不到語言模型  
**解決**:
- 檢查 `tesseract/tessdata/eng.traineddata` 是否存在
- 確認 TESSDATA_PREFIX 環境變數設定正確

#### 3. 識別率突然下降
**可能原因**:
- 圖像品質問題
- 信心度閾值設定不當
- 語言模型不適合

**診斷步驟**:
1. 檢視 OCR 原始輸出（所有識別文字）
2. 確認目標文字確實出現在圖像中
3. 嘗試調整 PSM 模式或信心度閾值

#### 4. 匹配失敗但 OCR 有識別到
**可能原因**:
- 文字不連續（組合匹配失敗）
- 特殊字元差異（重音符號等）
- 大小寫或空格問題

**診斷步驟**:
1. 對比目標文字和識別文字
2. 檢查特殊字元
3. 考慮增加模糊匹配規則

---

## 📈 版本歷史

### v1.0 (2025-11-20) - 當前版本
- ✅ 完成 Tesseract OCR 整合
- ✅ 實作精確組合匹配演算法
- ✅ 完全離線化部署
- ✅ 達成 8/12 (67%) 匹配成功率
- ✅ 消除誤匹配問題（如 "A" 不再匹配所有包含 A 的詞）

### v0.3 (2025-11-20)
- 嘗試 PaddleOCR（失敗，API 不穩定）
- 切換到 Tesseract OCR
- 實作基本組合匹配

### v0.2 (2025-11-20)
- 更新所有套件到最新版本
- 增加部分匹配功能（後來移除）

### v0.1 (初始版本)
- 使用 EasyOCR
- 基本完全匹配功能
- 成功率: 75%

---

## 📞 技術支援資訊

### 相關資源
- **Tesseract 官方文件**: https://github.com/tesseract-ocr/tesseract
- **pytesseract 文件**: https://github.com/madmaze/pytesseract
- **語言模型下載**: https://github.com/tesseract-ocr/tessdata

### 系統資訊
- **Python 版本**: 3.13.7
- **作業系統**: Windows
- **開發環境**: VS Code
- **測試日期**: 2025-11-20

---

## 🎓 結論

本專案成功實作了一個離線的 OCR 文字辨識系統，達成 67% 的匹配成功率。主要挑戰來自：
1. 非連續文字的組合
2. 重音符號的識別

未來改進方向應著重於多語言模型支援和更靈活的組合匹配演算法。

**專案狀態**: ✅ 可用於生產環境（需注意已知限制）

---

*本文件由系統自動生成，詳細記錄了專案的技術實作細節、設計決策和已知問題，便於未來維護和部署。*
